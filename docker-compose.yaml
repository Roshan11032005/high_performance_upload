version: "3.8"

services:
  # MinIO - S3-compatible object storage
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: strongpassword
    volumes:
      - minio_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  pg_db:
    image: postgres:17
    volumes:
      - pg_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    networks:
    - app-network
  # Flask Web Server

  flask_webserver:
    build:
      context: ./flask_webserver/.
    command: python3 manage.py runserver --debug
    volumes:
      - ./flask_webserver:/app/flask_webserver
    depends_on:
      - pg_db
    ports:
      - "5001:5001"
    networks:
    - app-network

  # gnet File Upload Server
  file_server:
    build:
      context: ./gnet-backend
      dockerfile: Dockerfile
    container_name: gnet_file_server
    ports:
      - "8081:8081" # Binary protocol
      - "8085:8085" # HTTP API (future use)
    environment:
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=admin
      - S3_SECRET_KEY=strongpassword
      - S3_BUCKET=uploads
      - S3_REGION=us-east-1
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # Gateway (Smart Router)
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: gateway
    ports:
      - "5000:5000" # HTTP gateway
      - "9090:9090" # Binary gateway
    depends_on:
      - flask_webserver
      - file_server
    networks:
      - app-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
    ports:
      - "3000:8081"
    depends_on:
      - flask_webserver
  

volumes:
  minio_data:
    driver: local
  pg_data:
    driver: local

networks:
  app-network:
    driver: bridge
